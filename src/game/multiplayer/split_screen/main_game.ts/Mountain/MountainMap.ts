

const rectsData = [[[-0.6890951276102089,0.10208816705336426],[-0.6890951276102089,-0.21577726218097448],[0.5754060324825986,-0.20649651972157773],[1.3666660594958921,-0.3733331674720485],[2.4399989159780318,-0.4199998134060545],[3.493331781345597,-0.4466664682254866],[4.619997947466601,-0.5066664415692086],[5.453330910573852,-0.6933330253052329],[6.333330519615109,-0.8333329631072511],[7.153330155312643,-1.0266662105481332],[7.859996508027592,-1.4199993691347559],[8.546662869627967,-1.9466658018185385],[8.986662674148596,-2.6066655085994817],[9.293329204572064,-3.1799985872172707],[9.733329009092692,-3.9066649310467936],[10.153328822498748,-4.593331292647169],[10.619995281838808,-5.479997565393284],[11.186661696751742,-6.559997085580282],[11.766661439074387,-7.426663367211822],[12.286661208053312,-8.13999638363163],[12.886660941490536,-9.059995974902034],[13.146660825979996,-10.073328858040451],[13.766660550531792,-11.54666153681407],[14.166660372823273,-12.69332769404965],[14.673326814392482,-13.993327116496962],[14.819993415899358,-14.339993629149578],[15.239993229305412,-15.126659946322823],[15.713326352350329,-15.673326370121181],[16.553325979162437,-16.31332608578755],[17.69332547269316,-16.759992554013035],[18.85999162104331,-16.939992474044203],[20.093324406442044,-16.953325801453918],[21.119990616990176,-16.719992571783887],[22.239990119406322,-16.233326121329252],[23.31998963959332,-15.586659741958027],[24.366655841256026,-14.499993558066171],[25.20305557418907,-13.831552794456941],[25.594087503331156,-13.859532622416161],[25.47915427212096,-14.319265547256935],[25.900576119891674,-14.319265547256935],[25.3833765794458,-14.951398318913],[25.747331811611417,-15.315353551078614],[25.21097673263051,-15.813397552989453],[25.670709657471285,-16.139041708085003],[24.90448811606999,-16.330597093435326],[25.076887962885284,-16.96272986509139],[24.80871042339483,-17.173440788976745],[25.21097673263051,-17.671484790887583],[24.94279919314006,-18.112062177193327],[25.230132271165544,-18.89743925712965],[26.5710199686178,-20.698059879422686],[29.310261979127418,-23.188279888976883],[31.09172706288542,-24.01196804598327],[34.386479690910974,-26.61712128674766],[36.70429985364988,-27.881386830059792],[39.079586631993884,-29.45214098993244],[40.17145232849072,-30.46738453228915],[41.761362026898404,-32.057294230696826],[42.91069433900034,-32.86182684916818],[44.213270959382534,-34.087781315410254],[45.324292194414404,-35.67769101381793],[46.875890815752015,-37.21013409662051],[47.92944543517879,-38.14875548483709],[49.615132826261636,-39.33639887400909],[50.99433160078396,-40.294175800760705],[52.469308067981444,-41.462663651397676],[53.90597345810886,-42.248040731334],[55.400105463841385,-42.57368488642955],[57.353970394414674,-42.8993290415251],[58.430521916277,-43.64013857884146],[60.05257067013004,-44.55076244065369],[61.532334445574904,-45.43292930678429],[62.81289925124835,-46.14435419882509],[63.72352311306058,-47.05497806063732],[66.05699675895443,-48.420913853355664],[68.4189274005299,-49.53073668493932],[70.7239440507421,-50.09987659857196],[71.37778296523952,-50.30257204265357],[71.72258265887011,-51.10710466112493],[71.3011608110994,-51.98825943373642],[72.29724881492108,-52.409681281507126],[73.77222528211855,-52.831103129277835],[75.26635728785108,-53.09928066876829],[75.97511221364726,-52.73532543660267],[77.16275560281926,-53.00350297609313],[78.0822214525008,-53.23336943851352],[79.03999837925242,-53.84634667163455],[80.2659528454945,-54.899901291061326],[81.07048546396584,-55.60865621685752],[82.00910685218243,-56.56643314360913],[83.42661670377481,-56.77714406749449],[85.05483747925255,-56.681366374819326],[86.33825856109972,-56.662210836284295],[87.94614511148087,-56.951780119304516],[88.86164444625712,-57.94464559504776],[88.55217988238908,-59.14382078003636],[89.48057357399315,-59.77564426460024],[92.89757813336927,-60.085108828468265],[95.12830186458461,-60.123791898951765],[96.52089240199072,-60.31720725136928],[96.76775112267616,-61.08750373800988],[96.0027525272298,-61.67764551163992],[96.680322711768,-62.50821541526739],[98.75674747083666,-63.01092877798927],[100.06817363445896,-63.2513569079867],[101.44517110626239,-63.579213448892276],[103.23745352987956,-63.46992793525708],[104.15545184441517,-63.42621372980301],[105.09530726167783,-63.120214291624464],[106.12259108984864,-62.879786161627045],[107.39030304801688,-62.836071956172965],[107.76187379437653,-63.207642702532624],[107.14987491801945,-63.601070551619316],[107.65258828074134,-63.77592737343562],[107.17173202074649,-64.10378391434121],[107.30287463710872,-64.58464017433604],[106.62530445257053,-64.99992512614978],[107.25916043165465,-65.02178222887682],[106.99687519893018,-65.50263848887167],[107.87115930801173,-65.26221035887424],[107.78373089710357,-65.98349474886652],[108.57058659527696,-65.54635269432575],[108.65801500618511,-65.9179234406854],[108.85472893072846,-65.48078138614463],[109.11701416345292,-65.87420923523132],[109.35744229345035,-65.21849615342016],[109.79458434799112,-65.61192400250687],[109.24815677981516,-64.80321120160643],[109.88201275889926,-64.82506830433347],[109.27001388254219,-64.30049783888455],[109.88201275889926,-63.950784195251934],[109.37929939617739,-63.51364214071116],[109.94758406708038,-63.40435662707597],[109.59787042344777,-63.01092877798928],[110.9748678952512,-63.44807083253004],[111.433867052519,-63.8196415788897],[112.08958013433016,-64.82506830433347],[112.70157901068724,-66.13649446795579],[113.86000545522029,-67.14192119339955],[114.58128984521255,-67.86320558339183],[115.75544757960681,-69.65423181178065],[116.8281577375686,-71.32076366432847],[118.0732677423457,-73.0639176710164],[118.47553405158139,-74.74960506209923],[119.14597790030753,-76.91418091655788],[120.0845992885241,-78.92551246273628],[120.6784209831101,-80.07484477483821],[121.46379806304643,-81.68391001178092],[122.88130791463884,-83.29297524872364],[124.45206207451149,-84.30821879108035],[126.02281623438414,-85.01697371687655],[127.51694824011665,-85.878972950953],[129.03023578438422,-86.30039479872372],[131.27143379298298,-86.472794645539],[132.66978810604033,-86.12799495190842],[134.3746310356582,-85.53417325732242],[135.40903011654996,-84.84457387006125],[136.2710293506264,-84.26990771401029],[136.73076227546719,-84.28906325254532],[136.34765150476653,-84.97866263980649],[136.9223176608175,-85.3426178719721],[136.29018488916145,-86.12799495190842],[137.03725089202769,-86.31955033725875],[137.24796181591304,-87.37310495668552],[137.59276150954364,-86.30039479872372],[138.32067197387485,-87.10492741719507],[138.07164997291943,-86.0513727977683],[138.8761825913908,-86.60688341528423],[138.83787151432074,-86.01306172069823],[139.43169320890672,-86.68350556942436],[139.83395951814242,-85.91728402802306],[140.58102552100868,-86.5877278767492],[140.9449807531743,-85.72572864267273],[141.73035783311062,-86.5877278767492],[141.86444660285582,-85.878972950953],[142.70729029839725,-86.4153280299339],[142.17093521941635,-85.49586218025236],[142.99462337642274,-85.32346233343706],[141.99853537260105,-85.03612925541158],[142.89884568374757,-84.49977417643068],[141.76866891018068,-84.42315202229055],[142.57320152865202,-83.96341909744977],[141.53880244776028,-84.02088571305487],[141.94106875699597,-83.75270817356441],[143.64591168661383,-83.77186371209945],[146.04035400349287,-84.82541833152622],[147.61017011592833,-85.34751963185002],[149.55546490480813,-85.24776092472797],[151.97461355251764,-85.87125284424073],[152.6479848255914,-86.89377959224166],[154.5434002609102,-88.16570310804768],[155.94002216061878,-88.73931567399943],[156.41387601944848,-90.06111854336648],[159.25699917242665,-90.8342485235623],[160.75337977925727,-91.85677527156322],[162.9979506895032,-92.00641333224628],[164.1701154981872,-93.2284574944913],[165.19264224618811,-94.60013971741935],[166.24010867096953,-95.59772678863978],[168.45973990443497,-95.27351099049314],[170.73025417569295,-95.2862347727432],[172.22560691587645,-95.57565788374647],[173.9139083967288,-96.15450410575299],[175.7469214330828,-97.36043373493324],[177.86935758044004,-98.75931210478234],[180.32945402396777,-100.39937640046749],[183.07897357849873,-101.9429663258182],[186.06967905886577,-104.35482558417871],[188.43330113205906,-106.23607580569991],[191.03810913108842,-108.31027476788995],[193.54644275978333,-110.0468134339095],[196.00653920331104,-111.34921743342419],[198.46663564683877,-112.8445701736077],[199.81727683152064,-115.35290380230263],[202.8562194970549,-117.6200515051615],[206.66695712526447,-120.65899417069575],[208.74115608745453,-122.92614187355463],[211.39420127165107,-125.43447550224955],[213.46840023384112,-127.94280913094448],[215.39788764052952,-131.271174907482],[217.03795193621465,-133.7312713510097],[218.43683030606377,-136.72197683137674],[220.26984334241777,-139.9538682375798],[222.3440423046078,-143.7646058657894],[224.56295282229945,-147.4788691236646],[227.1195236361616,-150.71076052986766],[230.54436378303353,-152.49553638105445],[234.25862704090872,-154.28031223224122],[237.87641592844946,-155.10034438008378],[240.77064703848208,-155.29329312075262],[245.40141681453426,-155.1968187504182],[248.68154540590453,-154.56973534324447],[252.00991118244204,-153.41204289923144],[255.33827695897955,-151.62726704804467],[256.8818668843303,-150.03543993752672],[258.28074525417935,-148.0577153456711],[259.4384376981924,-147.81652941983506],[258.61840555034985,-148.9742218638481],[259.58314925369405,-149.16717060451694],[258.28074525417935,-151.4343183073758],[260.21023266086775,-150.85547208536929],[259.0525402168547,-153.1708569733954],[260.499655771871,-153.31556852889702],[259.8725723646973,-155.148581565251],[261.7538225862185,-154.56973534324447]],[[263.3456496967364,-155.43800467625425],[264.6480536962511,-156.59569712026732],[264.88923962208713,-154.7626840839133],[266.4328295474379,-156.35451119443124],[266.8187270287756,-154.56973534324447],[268.21760539862464,-156.01685089826077],[268.69997725029674,-153.60499163990028],[270.2918043608147,-155.1968187504182],[270.48475310148353,-153.55675445473307],[272.1730545823359,-154.7626840839133],[271.2083108789917,-152.35082482555282],[273.2342726560145,-151.67550423321188],[271.54597117516215,-150.75899771503487],[273.42722139668336,-149.9872027523595],[271.49773398999497,-148.9259846786809],[273.5236957670178,-148.25066408633995],[277.9132796172339,-150.9037092705365],[284.9076714664793,-152.15787608488398],[289.5866784276987,-153.41204289923147],[297.2081536841179,-155.34153030591986],[302.85190434868156,-157.27101771260828],[306.5179304213895,-159.2487423044639],[311.0522258271073,-160.93704378531626],[314.2841172333104,-162.5288708958342],[317.22658552851016,-164.554832672857],[320.2655281940444,-167.69024970872567],[326.15046478444407,-170.29505770775503],[328.8517471538078,-171.40451296660086],[332.8071963375191,-172.99634007711882],[335.99085055855494,-174.58816718763674],[340.4286715939383,-176.90355207566282],[342.1169730747906,-178.97775103785287],[344.48059514798393,-181.38961029621336],[351.0890895158917,-184.4285529617476],[354.61040403309806,-184.4285529617476],[358.9999878833142,-183.75323236940667],[363.10014862252706,-183.4155720732362],[367.7309183985792,-183.12614896223295],[370.5769123234446,-182.98143740673132],[373.6640921741461,-185.2968222947574],[371.73460476745765,-186.8404122201081],[374.82178461815914,-189.0593227377998],[379.16313128320803,-189.83111770047515],[384.51745883676836,-189.83111770047515],[393.34486372236785,-190.36172673731446],[396.6249923137381,-190.45820110764888],[399.22980031276745,-190.5546754779833],[397.8791591280856,-193.8348040693536],[400.9181017936198,-194.8960221430322],[398.65095409076093,-198.03143917890088],[403.86057008881966,-198.1761507344025],[407.0924614950227,-198.75499695640903],[413.0256352705896,-199.18913162291392],[418.0423025279794,-199.71974065975323],[416.45047541746146,-202.0351255477793],[418.2834884538155,-203.8681385841333],[415.96810356578936,-206.47294658316264],[421.7083286006874,-207.53416465684126],[425.8567265250675,-207.67887621234289],[429.7639385236115,-208.01653650851335],[435.31121481784066,-207.87182495301172],[444.3798056292762,-208.35419680468385],[450.02355629383976,-211.44137665538528],[451.9048065153609,-213.56381280274255],[456.5838134765803,-217.32631324578492],[459.28509584594406,-221.42647398499778],[462.4205128818127,-224.89955131703692],[467.05128265786493,-229.6750326485907],[469.607853471727,-232.955161239961],[473.5633026554383,-236.13881546099688],[478.77291865349696,-240.14250182987533],[483.88606028122126,-242.16846360689814],[489.96394561228976,-242.31317516239977],[498.9360620533908,-241.78256612556046],[504.5798127179544,-238.79186064519342],[507.2810950873182,-235.07759738731826],[506.8469604208133,-231.5080456849447],[504.8692358289577,-227.89025679740394],[502.8432740519348,-226.53961561272206]]]
 
class MountainMap {
    body: Body|null;
    game: MainGame;
    material0 : Material;

    constructor(filePath: string, game: MainGame) {
        this.game = game;
        this.material0 = Material.of(0, 0.3, 0.0);
        this.body = null;
        this.loadMountains(filePath).then(() => {
            console.log('Mountains loaded successfully.');
        }).catch(error => {
            console.error('Failed to load mountain data:', error);
        });
    }

    async loadMountains(filePath: string): Promise<void> {

        const body = Body.of(this.game.physicsEngine);        

        rectsData.forEach(rectList => {
            for (let i = 0; i < rectList.length - 1; i += 1) { // Ensuring points are taken in pairs
                const p1 = new Vector2D(rectList[i][0], rectList[i][1]);
                const p2 = new Vector2D(rectList[i + 1][0], rectList[i + 1][1]);
                body.polygons.push(this.createRectangleFromPoints (p1, p2, 1)); // This should be adjusted to the actual vertices calculation
            }
        });
        body.position.set(Vector2D.cartesian(0,0));
        body.setTrueAcceleration(Vector2D.cartesian(0,0));
        body.angularLightness = 0;
        body.lightness = 0;

        this.game.physicsEngine.bodies.push(body);

        this.body = body;
    }


    tick(context: SplitScreenGameContext, distanceThreshold: number) {

        const lastOuterArray = rectsData[rectsData.length - 1];  // Last array of rectsData
const lastInnerArray = lastOuterArray[lastOuterArray.length - 1];  // Last array of the last outer array
const targetPoint = Vector2D.cartesian(lastInnerArray[0], lastInnerArray[1]);


            // Loop through each player index (assuming player indexes are sequential starting from 0)
            for (let i = 0; i < this.game.getMaxPlayers(context); i++) {
                const hat = this.game.getHatForPlayer(i);
        
                if (hat) { // Ensure hat object is valid
                    const playerPosition = hat.body.position; // Assuming getPosition() returns Vector2D representing player's current position
        
                    // Calculate the distance from the player to the target point
                    const distance = Vector2D.distance(playerPosition, targetPoint);
    
                    // Check if the distance is within the threshold
                    if (distance <= distanceThreshold &&  this.game.isPlayerTouchingBody(i, this.game.requireNGon().body)){
                        console.log(`Player ${i} is within ${distanceThreshold} units of the target point.`);
                        this.game.winner = i
                        // Perform further actions as needed
                    }
                }
            }
    }

    createRectangleFromPoints(p1: Vector2D, p2: Vector2D, thickness: number): PhysicalPolygon {
        const direction = Vector2D.fromPoints(p1, p2);
        direction.normalize();  // Direction from p1 to p2
        let perp = Vector2D.perpendicularClockwise(direction);
        perp.normalize()
        perp = Vector2D.multiply(perp, thickness / 2) 

        // Define the rectangle's verticesapp
        const pointsVector =[
            Vector2D.add(p1, perp),
            Vector2D.add(p2, perp),
            p2,
            p1
        ];

        const polygon = PhysicalPolygon.of(TransformedConvexPolygon.of(pointsVector), this.material0);
        return polygon;


    }

    moveVertexAlongNormal(
        chain: number[][], vertexIndex: number, normalIndex: number, 
        amount: number
    ) {
        const vertex = Vector2D.cartesian(
            chain[vertexIndex][0], chain[vertexIndex][1]
        );
        const vertex0 = Vector2D.cartesian(
            chain[normalIndex][0], chain[normalIndex][1]
        );
        const vertex1 = Vector2D.cartesian(
            chain[normalIndex + 1][0], chain[normalIndex + 1][1]
        );
        const normal = Vector2D.perpendicularCounterClockwise(
            Vector2D.subtract(vertex1, vertex0)
        );
        normal.normalize();
        return Vector2D.addMultiplied(
            vertex, normal, -amount
        );
    }

    render(
        context: SplitScreenGameContext, region: AABB, lag: number, playerIndex: number
    ) {
        const renderer = context.getRenderer();
        renderer.strokeStyle = 'white';
        renderer.lineWidth = 0.2;
        const moveAmount = 0.5 * renderer.lineWidth;
        for (const chain of rectsData) {
            if (chain.length <= 1) {
                continue;
            }
            renderer.beginPath();
            let position = this.moveVertexAlongNormal(
                chain, 0, 0, moveAmount
            );
            renderer.moveTo(position.x, position.y);
            for (let i = 1; i < chain.length - 1; i++) {
                position = this.moveVertexAlongNormal(
                    chain, i, i, moveAmount
                )
                renderer.lineTo(position.x, position.y);
            }
            renderer.stroke();
        }
    }
    
}